# 0007 — CocktailDB Mirror & SQLite Snapshots
Status: Proposed → (Accept upon merge)
Date: 2025-10-08

## Context
We need fast, offline-ready cocktail lookups in the mobile app. Calling TheCocktailDB from devices is slow, costly, and violates our contracts-first + privacy posture. We also want deterministic search and stable DTOs.

## Decision
- Mirror TheCocktailDB premium data into Azure Database for PostgreSQL via a **timer-triggered Azure Function**.
- Generate a **versioned, read-only SQLite snapshot** from PG and publish to Blob Storage.
- Mobile downloads the latest snapshot on first run and when a **snapshotVersion** bump is detected.
- Provide two HTTP endpoints:
  1. `GET /v1/snapshots/latest` (anonymous read; returns signed URL + metadata)
  2. `GET /v1/changes?since=...` (optional, post-MVP)
- Keep **no PII**; follow KV for secrets; add robust backoff, ETag/If-Modified-Since to respect 3rd-party rate limits.

## Alternatives Considered
- Direct mobile → TheCocktailDB: rejected (latency, cost, service dependency, offline failure).
- Mobile builds DB from JSON feed: higher battery/network cost; snapshot is simpler and faster.
- Use APIM/CDN: maybe later; start with signed Blob URLs.

## Data Model (PostgreSQL)
- `drinks(id, name, instructions, glass_id, category_id, image_url, tags[], iba, is_alcoholic, updated_at)`
- `ingredients(id, name, description, type, abv, is_alcohol)`
- `measures(drink_id, ingredient_id, measure_text, ordinal)`  -- junction
- `categories(id, name)`
- `glasses(id, name)`
- Indexes:
  - `drinks(name)`, `GIN(tags)`, `measures(drink_id)`, `measures(ingredient_id)`
- Partitioning: not needed initially (row count modest); revisit >100k drinks.
- TTL: none (catalog); keep `updated_at` for sync.

## Storage Plan
- Blob container: `snapshots`
  - Path: `sqlite/{schemaVersion}/{snapshotVersion}.db.zst`
  - Sidecar: `.sha256` and `metadata.json`
- Snapshot versioning:
  - `schemaVersion`: manual bump on schema change (e.g., `1`)
  - `snapshotVersion`: yyyymmdd.N (e.g., `20251008.1`)

## Security & Privacy
- Secrets in **Key Vault** via app settings references; Managed Identity to read.
- No PII stored. No tokens logged. Redact URLs/keys from logs.
- Public read is via **short-lived SAS** generated by Function; endpoint itself can be anonymous.

## Telemetry/Logging
- App Insights with correlation IDs.
- Log: `sync.runId`, `source.etag`, `fetched.counts`, `pg.upserts`, `snapshot.bytes`, `sha256`.
- Sampling enabled; never log API keys or request bodies from 3rd party.

## Cost
- Functions (Timer + 2 HTTP): negligible at MVP volumes.
- PostgreSQL: Flexible Server Burstable (B2ms) ~$30–$60/mo.
- Blob: ~50–150MB snapshot; egress per download ~pennies per user.
- Growth: regenerate snapshot daily or on upstream changes; consider CDN later.
