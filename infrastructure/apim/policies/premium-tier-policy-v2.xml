<!--
  Premium Tier Policy for MyBartenderAI ($4.99/month)
  - Daily quota: 1,000 API calls per day
  - Rate limit: 20 calls per minute (abuse prevention)
  - Features: AI (100/month), Voice (30 min/month), Vision (5 scans/month)
  - Priority routing
-->
<policies>
    <inbound>
        <base />

        <!-- Rate limiting: 20 calls per minute -->
        <rate-limit calls="20" renewal-period="60" />

        <!-- Daily quota: 1,000 calls per day -->
        <quota calls="1000" renewal-period="86400" />

        <!-- Add tier information -->
        <set-header name="X-User-Tier" exists-action="override">
            <value>premium</value>
        </set-header>

        <!-- Add correlation ID if not present -->
        <choose>
            <when condition="@(!context.Request.Headers.ContainsKey("X-Correlation-Id"))">
                <set-header name="X-Correlation-Id" exists-action="override">
                    <value>@(Guid.NewGuid().ToString())</value>
                </set-header>
            </when>
        </choose>

        <!-- Forward to backend -->
        <set-backend-service base-url="https://func-mba-fresh.azurewebsites.net/api" />
    </inbound>

    <backend>
        <base />
    </backend>

    <outbound>
        <base />

        <!-- Add tier information to response headers -->
        <set-header name="X-User-Tier" exists-action="override">
            <value>premium</value>
        </set-header>

        <!-- Add rate limit headers -->
        <set-header name="X-Rate-Limit-Limit" exists-action="override">
            <value>1000</value>
        </set-header>
    </outbound>

    <on-error>
        <base />

        <!-- Custom error response -->
        <set-header name="Content-Type" exists-action="override">
            <value>application/json</value>
        </set-header>
        <set-body>@{
            return new JObject(
                new JProperty("code", context.LastError.Source),
                new JProperty("message", context.LastError.Message),
                new JProperty("traceId", context.RequestId)
            ).ToString();
        }</set-body>
    </on-error>
</policies>
