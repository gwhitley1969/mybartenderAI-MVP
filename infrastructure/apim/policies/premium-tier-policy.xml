<!--
  Premium Tier Policy for MyBartenderAI ($4.99/month)
  - Rate limit: 1,000 API calls per day
  - Features: AI (100/month), Voice (30 min/month), Vision (5 scans/month)
  - Priority routing
-->
<policies>
    <inbound>
        <base />

        <!-- Rate limiting: 1,000 calls per day -->
        <rate-limit calls="1000" renewal-period="86400" />

        <!-- Quota: Track daily API usage -->
        <quota calls="1000" renewal-period="86400" />

        <!-- Add tier information -->
        <set-header name="X-User-Tier" exists-action="override">
            <value>premium</value>
        </set-header>

        <!-- Add correlation ID if not present -->
        <choose>
            <when condition="@(!context.Request.Headers.ContainsKey("X-Correlation-Id"))">
                <set-header name="X-Correlation-Id" exists-action="override">
                    <value>@(Guid.NewGuid().ToString())</value>
                </set-header>
            </when>
        </choose>

        <!-- Forward to backend -->
        <set-backend-service backend-id="func-mba-fresh-backend" />
    </inbound>

    <backend>
        <base />
        <!-- Premium tier gets slightly higher timeout -->
        <forward-request timeout="30" />
    </backend>

    <outbound>
        <base />

        <!-- Add tier information to response headers -->
        <set-header name="X-User-Tier" exists-action="override">
            <value>premium</value>
        </set-header>

        <!-- Add rate limit headers -->
        <set-header name="X-Rate-Limit-Limit" exists-action="override">
            <value>1000</value>
        </set-header>
        <set-header name="X-Rate-Limit-Remaining" exists-action="override">
            <value>@(context.Response.Headers.GetValueOrDefault("Rate-Limit-Remaining","0"))</value>
        </set-header>

        <!-- Cache snapshot endpoint responses -->
        <choose>
            <when condition="@(context.Request.Url.Path.Contains("/v1/snapshots/latest"))">
                <cache-store duration="300" />
            </when>
        </choose>
    </outbound>

    <on-error>
        <base />

        <!-- Custom error response -->
        <set-header name="Content-Type" exists-action="override">
            <value>application/json</value>
        </set-header>
        <set-body>@{
            return new JObject(
                new JProperty("code", context.LastError.Source),
                new JProperty("message", context.LastError.Message),
                new JProperty("traceId", context.RequestId)
            ).ToString();
        }</set-body>
    </on-error>
</policies>
