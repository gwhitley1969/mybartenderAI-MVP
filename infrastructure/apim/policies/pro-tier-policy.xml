<!--
  Pro Tier Policy for MyBartenderAI ($9.99/month)
  - Rate limit: Unlimited (10,000 calls per day for abuse prevention)
  - Features: Unlimited AI, Voice (5 hours/month), Vision (50 scans/month)
  - Highest priority routing
  - Dedicated support
-->
<policies>
    <inbound>
        <base />

        <!-- Rate limiting: 10,000 calls per day (abuse prevention) -->
        <rate-limit calls="10000" renewal-period="86400" />

        <!-- Quota: Track daily API usage -->
        <quota calls="10000" renewal-period="86400" />

        <!-- Add tier information -->
        <set-header name="X-User-Tier" exists-action="override">
            <value>pro</value>
        </set-header>

        <!-- Add priority flag for backend -->
        <set-header name="X-Priority-User" exists-action="override">
            <value>true</value>
        </set-header>

        <!-- Add correlation ID if not present -->
        <choose>
            <when condition="@(!context.Request.Headers.ContainsKey("X-Correlation-Id"))">
                <set-header name="X-Correlation-Id" exists-action="override">
                    <value>@(Guid.NewGuid().ToString())</value>
                </set-header>
            </when>
        </choose>

        <!-- Forward to backend -->
        <set-backend-service backend-id="func-mba-fresh-backend" />
    </inbound>

    <backend>
        <base />
        <!-- Pro tier gets highest timeout -->
        <forward-request timeout="60" />
    </backend>

    <outbound>
        <base />

        <!-- Add tier information to response headers -->
        <set-header name="X-User-Tier" exists-action="override">
            <value>pro</value>
        </set-header>

        <!-- Add rate limit headers -->
        <set-header name="X-Rate-Limit-Limit" exists-action="override">
            <value>10000</value>
        </set-header>
        <set-header name="X-Rate-Limit-Remaining" exists-action="override">
            <value>@(context.Response.Headers.GetValueOrDefault("Rate-Limit-Remaining","0"))</value>
        </set-header>

        <!-- Cache snapshot endpoint responses -->
        <choose>
            <when condition="@(context.Request.Url.Path.Contains("/v1/snapshots/latest"))">
                <cache-store duration="300" />
            </when>
        </choose>

        <!-- Add Pro tier indicator -->
        <set-header name="X-Pro-Tier" exists-action="override">
            <value>true</value>
        </set-header>
    </outbound>

    <on-error>
        <base />

        <!-- Custom error response -->
        <set-header name="Content-Type" exists-action="override">
            <value>application/json</value>
        </set-header>
        <set-body>@{
            return new JObject(
                new JProperty("code", context.LastError.Source),
                new JProperty("message", context.LastError.Message),
                new JProperty("traceId", context.RequestId),
                new JProperty("support", "For Pro tier support, contact support@mybartenderai.com")
            ).ToString();
        }</set-body>
    </on-error>
</policies>
